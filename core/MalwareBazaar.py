import requests
from core.core import *
from fake_useragent import UserAgent
from tabulate import tabulate 

class MalwareBazaar:
    def hash_lookup(hash):
        try:
            print(f"\nChecking hash on MalwareBazaar for {c.Orange}{hash}{c.Reset}")
            url = "https://mb-api.abuse.ch/api/v1/"
            agent=UserAgent().random
            headers = { 'User-Agent': agent }
            data = {'query':'get_info','hash': hash}
        
            response = requests.post(url, headers=headers, data=data)

            if response.status_code==200:
                res=response.json()
                if 'data' in res:
                    data=res['data'][0]
                    jsondata=[]
                    try:
                        sha256_hash=['sha256_hash',data['sha256_hash']]
                        jsondata.append(sha256_hash)
                    except:
                        pass
                    try:
                        md5_hash=['md5_hash',data['md5_hash']]
                        jsondata.append(md5_hash)
                    except:
                        pass
                    try:
                        first_seen=['first_seen',f'{c.Orange}{data["first_seen"]}{c.Reset}']
                        jsondata.append(first_seen)
                    except:
                        pass
                    try:
                        file_name=['file_name',f'{c.Orange}{data["file_name"]}{c.Reset}']
                        jsondata.append(file_name)
                    except:
                        pass
                    try:
                        file_type_mime=['file_type_mime',data['file_type_mime']]
                        jsondata.append(file_type_mime)
                    except:
                        pass
                    try:
                        file_type=['file_type',data['file_type']]
                        jsondata.append(file_type)
                    except:
                        pass
                    try:
                        signature=['signature',f'{c.Red}{data["signature"]}{c.Reset}']
                        jsondata.append(signature)
                    except:
                        pass
                    try:
                        comment=['comment',f'{c.Orange}{data["comment"]}{c.Reset}']
                        jsondata.append(comment)
                    except:
                        pass

                    header=["Name","Value"]
                    print(tabulate(jsondata, header,  tablefmt="grid",numalign="left",showindex=True,floatfmt=".2f"))
        except:
            print(f"{c.Red}Error on hash lookup process for MalwareBazaar!{c.Reset}")
            pass